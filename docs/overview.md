# 要件定義書

## 1. 概要

このゲームのタイトルは「Pythonia (パイソニア)」 。  
ジャンルはパズル。 パズル感覚で Python のプログラミング問題を解いていくというようもの。  
ユーザーは楽しみながら Python やアルゴリズムについて学べます。  
本アプリは、Python 構文を題材にした**コードパズル学習ゲーム**である。  
プレイヤーはコードピースをドラッグ＆ドロップで並べ、正しい構文を完成させる。  
ゲーム進行や評価は Supabase と連携し、ユーザー情報や成績を記録する。

---

## 2. ゲームの目的

- プログラミング初学者が**構文理解・ロジック思考**を体験的に学ぶ。
- 各問題で正しいコードを組み立て、**完全一致**で合格。
- 難易度・達成率・評価などを可視化し、継続学習を促進する。

---

## 3. 対応プラットフォーム

- iOS / Android（Unity ビルド）
- 解像度：縦向き・横向き両対応（初期は横向き）
- 操作方法：タップ・ドラッグ＆ドロップのみ

---

## 4. ゲームフロー

| ステップ | 画面                     | 概要                                                   |
| -------- | ------------------------ | ------------------------------------------------------ |
| 1        | **タイトル画面**         | ゲーム開始、設定、課金、アカウント情報へ               |
| 2        | **パズルセット選択画面** | 「初心者向けセット」「外資系対策セット」などの分類一覧 |
| 3        | **問題選択画面**         | 選択したセット内の 10〜15 問のリスト                   |
| 4        | **パズル画面**           | コードブロックを並べて実行（ヒント・問題文確認あり）   |
| 5        | **結果画面**             | 所要時間・星評価・難易度フィードバック入力             |
| 6        | **リトライ/次へ**        | 再挑戦または次の問題へ進む                             |

---

## 5. ゲーム仕様詳細

### 5.1 コードブロック（ピース）

- 左側に「ピース置き場（手札）」、右側に「配置グリッド」。
- 各ピースは以下の性質を持つ：

| 属性         | 内容                                         |
| ------------ | -------------------------------------------- |
| 文言         | `for i in range(1, n+1):` など固定テキスト   |
| 移動可否     | `is_fixed = true` の場合は配置済みで移動不可 |
| ピースタイプ | 制御構文 / 代入 / 出力 / return など分類     |
| ツールチップ | 長押しで構文の説明（日本語/英語切替）        |
| 使用制限     | 手札から使用すると消える（複製不可）         |
| 並び順       | ランダムシャッフル                           |

---

### 5.2 配置グリッド

- 行：文の順序
- 列：インデント段階（最大 6）
- ピースはスナップ配置され、横ドラッグでインデント変更可能。
- 不正配置（if 無しの else など）は「実行」時にエラー判定。

---

### 5.3 実行・判定

- 「実行」ボタンでユーザー配置を正解データと照合。
- **完全一致（順序・インデント・ピース構成）**で正解。
- 正解パターンが複数ある場合はどちらでも合格。

---

### 5.4 ヒント・問題文

| 要素         | 内容                                                  |
| ------------ | ----------------------------------------------------- |
| 問題文を確認 | 問題文・例・画像をモーダルで表示                      |
| ヒント       | 最大 3 つまで。押すたびにテキストヒントが段階的に表示 |
| コスト       | ライフ消費なし。ただし星評価に −1 補正                |

---

### 5.5 評価・スコア

| 要素       | 内容                                                   |
| ---------- | ------------------------------------------------------ |
| 評価基準   | 3 段階（★1〜3）                                        |
| 減点要素   | ヒント使用、ミス（不正解）ごとに −1                    |
| 表示       | 結果画面で星＋経過秒を表示                             |
| 難易度入力 | 「楽勝 / まあまあ / むずかしい」をユーザーが選択し記録 |

---

### 5.6 ライフ・失敗

- ステージごとに初期ライフ数を設定。
- ミス時にライフ −1（盤面は維持）。
- ライフ 0 でタイトル画面へ。
- 課金ユーザーは常時ライフ＋ 2。

---

### 5.7 音・設定

- ドラッグ音 / 成功 SE / 失敗 SE あり。
- 設定メニュー：

  - サウンド ON/OFF
  - 言語切替（ja/en）
  - トップへ戻る
  - 長押しツールチップ ON/OFF

---

## 6. データ構造（Supabase）

主要テーブルは以下。

| テーブル                 | 用途                                                       |
| ------------------------ | ---------------------------------------------------------- |
| users                    | アカウント管理（メール、ニックネーム、課金状態など）       |
| products                 | 課金商品（広告非表示、ライフ増加、セット購入など）         |
| purchases                | 課金履歴                                                   |
| entitlements             | 所持中の権限（どのセットを遊べるかなど）                   |
| puzzle_sets              | 問題セット（例：「初心者セット」「外資対策セット」）       |
| puzzles                  | 各問題データ（タイトル、問題文、正解パターン、難易度など） |
| puzzle_pieces            | 問題ごとのピース配置定義（文言、正解座標、is_fixed など）  |
| piece_archetypes         | ピース共通定義（help_ja / help_en などツールチップ共通化） |
| user_progress            | 各ユーザーの進捗・星評価・経過時間など                     |
| user_difficulty_feedback | ユーザーによる難易度フィードバック                         |
| events                   | イベントログ（開始・実行・クリアなど）                     |
| devices                  | 端末識別（同一アカウントの複数端末対応）                   |

---

## 7. 保存と通信

- **オフライン時**

  - ローカル（PlayerPrefs/JSON）に進捗を保存。
  - 次回オンライン時に Supabase と同期。

- **オンライン時**

  - Supabase REST API 経由で読み書き。
  - 進捗・課金・フィードバックを即時反映。

---

## 8. UI 構成（主要画面）

### 8.1 タイトルシーン

- 「Start」ボタン → PuzzleSelect へ遷移
- 「設定」ボタン → 言語/音設定

### 8.2 PuzzleSelect シーン

- 各セットをカード UI で表示
- Locked（課金未購入）/Unlocked 表示
- Progress Bar 付き

### 8.3 Puzzle シーン

- 左：ピース置き場（スクロール可）
- 右：グリッド配置エリア（行 × 列）
- 下部：実行 / ヒント / 問題文ボタン

### 8.4 Result シーン

- ★ 評価表示
- 経過時間
- 「もう一度」「次の問題へ」
- 難易度アンケート（楽勝・まあまあ・むずかしい）

---

## 9. 技術仕様（Unity）

| 項目           | 内容                                       |
| -------------- | ------------------------------------------ |
| エンジン       | Unity 2022 LTS                             |
| UI             | Unity UI (Canvas, LayoutGroup, ScrollView) |
| アニメーション | DOTween 利用（ボタン点滅・成功演出）       |
| データ通信     | Supabase REST API / UnityWebRequest        |
| ローカル保存   | PlayerPrefs + JSON                         |
| 言語切替       | ScriptableObject or JSON ローカライズ辞書  |

---

## 10. 拡張予定

- ステージ作成モード（教師向け）
- 週替りパズルイベント
- 連続ログインボーナス
- ユーザーランキング（平均クリア時間）

---

## 11. 非機能要件

| 項目             | 内容                                  |
| ---------------- | ------------------------------------- |
| FPS 目標         | 60                                    |
| 対応 OS          | iOS 14+ / Android 9+                  |
| 起動時間         | 5 秒以内                              |
| セキュリティ     | Supabase Auth + HTTPS 通信            |
| 同期戦略         | ローカル優先・サーバ後追い更新方式    |
| アクセシビリティ | 色弱対応テーマ / Haptics 対応（任意） |

---

## 12. 完成定義（Definition of Done）

- 全画面遷移が可能である
- 各ピースがドラッグ＆スナップ動作する
- 実行判定が完全一致で正しく動作
- Supabase とのデータ同期が成功
- 英語/日本語 UI が切替可能
- スマホ実機で操作・表示崩れがない
